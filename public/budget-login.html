<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Budget Login</title>
<body style="--bg:#0b0d10;--panel:#10141a;--muted:#9fb3c8;--line:#1b2430;--txt:#e9eef4;font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--txt);background:var(--bg)">
  <div style="max-width:560px;margin:12vh auto;padding:24px;background:var(--panel);border:1px solid var(--line);border-radius:16px">
    <h1 style="margin:0 0 12px;font-size:22px">Budget Portal</h1>
    <p style="margin:0 0 18px;color:var(--muted);font-size:14px">Enter your budget credentials.</p>

    <form id="f" style="display:grid;gap:12px">
      <label style="display:grid;gap:6px">
        <span style="color:var(--muted);font-size:12px">Budget number (6 digits)</span>
        <input id="bn" name="budgetNumber" required inputmode="numeric" maxlength="6"
               pattern="[0-9]{6}" placeholder="090909" autocomplete="one-time-code"
               style="background:#0d1117;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px;outline:none"/>
      </label>
      <label style="display:grid;gap:6px">
        <span style="color:var(--muted);font-size:12px">Budget holder name</span>
        <input id="hn" name="holderName" required placeholder="e.g. Liam Sheerin" autocomplete="name"
               style="background:#0d1117;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px;outline:none"/>
      </label>
      <label style="display:grid;gap:6px">
        <span style="color:var(--muted);font-size:12px">PIN</span>
        <input id="pin" name="pin" required inputmode="numeric" maxlength="12"
               pattern="[0-9]{4,12}" placeholder="••••••" autocomplete="current-password" type="password"
               style="background:#0d1117;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px;outline:none"/>
        <span style="color:var(--muted);font-size:11px">Digits only.</span>
      </label>

      <button id="go" style="margin-top:8px;background:#19b37a;border:none;border-radius:10px;padding:10px 14px;color:#04160f;cursor:pointer;font-weight:700">Log in</button>
      <div id="msg" style="color:#ff8aa0;min-height:1.2em"></div>
    </form>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    async function readJsonOrText(res){
      const t = await res.text();
      try { return t ? JSON.parse(t) : null; } catch { return t || null; }
    }
    async function req(url, opts={}){
      const r = await fetch(url, { credentials:'include', ...opts });
      const d = await readJsonOrText(r);
      if(!r.ok){
        const msg = (d && (d.error || d.message)) || r.statusText || 'Request failed';
        const e = new Error(msg); e.status=r.status; e.data=d; throw e;
      }
      return d;
    }

    function digitsOnly(s){ return (s||'').replace(/\D+/g,''); }

    $('#f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      $('#msg').textContent = '';

      const bn  = digitsOnly($('#bn').value).slice(0,6);
      const hn  = ($('#hn').value || '').replace(/\s+/g,' ').trim();
      const pin = digitsOnly($('#pin').value);

      $('#bn').value  = bn;
      $('#hn').value  = hn;
      $('#pin').value = pin;

      if(!/^[0-9]{6}$/.test(bn)){ $('#msg').textContent='Budget number must be 6 digits.'; $('#bn').focus(); return; }
      if(!hn){ $('#msg').textContent='Budget holder name is required.'; $('#hn').focus(); return; }
      if(!/^[0-9]{4,12}$/.test(pin)){ $('#msg').textContent='PIN must be digits only.'; $('#pin').focus(); return; }

      const body = { budgetNumber: bn, holderName: hn, pin };

      const btn = $('#go'); btn.disabled = true; const old = btn.textContent; btn.textContent='Checking…';
      try{
        await req('/api/budget/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        // Redirect to the correct portal page
        location.href = '/budget-portal.html';
      }catch(err){
        $('#msg').textContent = err.message || 'Login failed';
      }finally{
        btn.disabled = false; btn.textContent = old;
      }
    });
  </script>
</body>
</html>
